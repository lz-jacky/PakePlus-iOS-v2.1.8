<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>æ™ºèƒ½è®°è´¦ Â· æœ€ç»ˆç‰ˆ</title>
    <!-- å¼•å…¥ SheetJS ç”¨äºè§£æ Excel æ–‡ä»¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* ä¼˜åŒ–åçš„æ ·å¼ï¼šæ›´ç°ä»£ã€æ›´æ¸…æ™° */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: #f0f3f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 12px;
        }

        .phone-frame {
            max-width: 400px;
            width: 100%;
            background-color: white;
            border-radius: 40px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            overflow: hidden;
            padding: 24px 20px 28px;
            border: 1px solid rgba(255,255,255,0.3);
            position: relative;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 0 16px;
            font-size: 15px;
            font-weight: 500;
            color: #1e293b;
        }

        .current-date {
            background: #f1f5f9;
            padding: 8px 18px;
            border-radius: 40px;
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar {
            width: 44px;
            height: 44px;
            border-radius: 30px;
            background: linear-gradient(145deg, #1e293b, #0f172a);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .avatar:active { transform: scale(0.95); }

        .auth-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .auth-card {
            background: white;
            max-width: 360px;
            width: 100%;
            border-radius: 48px;
            padding: 32px 24px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            background: #f1f5f9;
            border-radius: 40px;
            padding: 6px;
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 14px 0;
            border-radius: 34px;
            font-weight: 600;
            font-size: 16px;
            color: #64748b;
            cursor: pointer;
            transition: all 0.1s;
        }

        .auth-tab.active {
            background: #1e293b;
            color: white;
        }

        .auth-input {
            width: 100%;
            padding: 18px 18px;
            font-size: 16px;
            background: #f1f5f9;
            border: none;
            border-radius: 40px;
            margin: 12px 0;
            outline: none;
            transition: box-shadow 0.1s;
        }
        .auth-input:focus { box-shadow: 0 0 0 2px #1e293b; }

        .auth-btn {
            width: 100%;
            background: #1e293b;
            color: white;
            border: none;
            padding: 18px;
            border-radius: 40px;
            font-size: 18px;
            font-weight: 600;
            margin: 20px 0 10px;
            cursor: pointer;
            transition: opacity 0.1s;
        }
        .auth-btn:active { opacity: 0.8; }

        .logout-btn { background: #c83e4d; }

        .tab-bar {
            display: flex;
            background: #f8fafc;
            border-radius: 50px;
            padding: 6px;
            margin: 20px 0 20px;
            gap: 6px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.02);
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            border-radius: 40px;
            font-weight: 600;
            font-size: 14px;
            color: #64748b;
            cursor: pointer;
            transition: all 0.15s;
        }

        .tab.active {
            background: #1e293b;
            color: white;
            box-shadow: 0 6px 14px rgba(30,41,59,0.3);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .page-container {
            min-height: 520px;
            display: flex;
            flex-direction: column;
        }

        .app-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(145deg, #1e293b, #0f172a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .welcome-message {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .balance-card {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border-radius: 32px;
            padding: 24px 20px;
            color: white;
            box-shadow: 0 15px 30px -10px rgba(0,0,0,0.3);
            margin-top: 4px;
        }

        .balance-row {
            display: flex;
            justify-content: space-around;
            margin-bottom: 0;
        }

        .balance-item { text-align: center; }
        .balance-label { font-size: 14px; opacity: 0.8; margin-bottom: 6px; }
        .balance-value { font-size: 28px; font-weight: 700; }
        .balance-value.income { color: #4ade80; }
        .balance-value.expense { color: #f87171; }

        .time-range-selector {
            margin: 20px 0 12px;
        }
        .time-range-selector select {
            width: 100%;
            padding: 16px 20px;
            font-size: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 50px;
            background: white;
            color: #1e293b;
            font-weight: 600;
            outline: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23475569' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 18px center;
            background-size: 20px;
        }
        .time-range-selector select:focus { border-color: #1e293b; }

        .custom-date-range {
            display: flex;
            gap: 8px;
            margin: 12px 0;
            align-items: center;
        }
        .date-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 40px;
            font-size: 13px;
        }
        .query-btn {
            background: #1e293b;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
        }

        .range-summary {
            background: #f8fafc;
            border-radius: 28px;
            padding: 16px 12px;
            margin: 16px 0;
            display: flex;
            justify-content: space-around;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.02);
        }
        .summary-box { text-align: center; }
        .summary-label { font-size: 12px; color: #64748b; }
        .summary-number { font-size: 18px; font-weight: 700; color: #1e293b; }

        .quick-add {
            background: #f1f5f9;
            border-radius: 50px;
            margin: 20px 0 20px;
            padding: 6px 6px 6px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .add-btn {
            background: #1e293b;
            border: none;
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 40px;
            font-size: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .filter-row {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
        }
        .filter-chip {
            background: #f1f4f9;
            padding: 10px 20px;
            border-radius: 40px;
            font-size: 14px;
            font-weight: 600;
            color: #3a4a5e;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.1s;
        }
        .filter-chip.active {
            background: #1e293b;
            color: white;
            box-shadow: 0 4px 10px rgba(30,41,59,0.3);
        }

        .list-container {
            flex: 1;
            min-height: 240px;
            max-height: 240px;
            overflow-y: auto;
            border-radius: 28px;
            background: #f9fcff;
            padding: 4px;
        }
        .transactions-list { list-style: none; }
        .transactions-list li {
            background: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-radius: 24px;
            margin-bottom: 6px;
            border: 1px solid #eef2f6;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
            transition: background 0.1s;
        }
        .tx-left { display: flex; align-items: center; gap: 14px; }
        .tx-cat-icon {
            width: 44px; height: 44px; border-radius: 30px;
            background: #e4eaf2; display: flex; align-items: center;
            justify-content: center; font-size: 22px;
        }
        .tx-info { display: flex; flex-direction: column; }
        .tx-desc { font-size: 16px; font-weight: 600; color: #1f2a3a; }
        .tx-merchant { font-size: 12px; color: #8e9daf; margin-top: 2px; }
        .tx-right { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        .tx-amount { font-size: 18px; font-weight: 650; }
        .tx-amount.income { color: #2b7e4b; }
        .tx-amount.expense { color: #c83e4d; }
        .tx-date { font-size: 11px; color: #8e9daf; }
        .delete-tx {
            background: transparent; border: none; font-size: 16px;
            color: #b1c2d6; padding: 4px 4px 4px 8px; cursor: pointer;
        }

        /* å¯¼å…¥é¢„è§ˆå¢å¼ºæ ·å¼ */
        .import-preview {
            background: white;
            border-radius: 28px;
            padding: 16px;
            max-height: 360px;
            overflow-y: auto;
            margin-top: 16px;
            font-size: 13px;
            border: 1px solid #eef2f6;
        }
        .preview-table {
            width: 100%;
            border-collapse: collapse;
        }
        .preview-table th {
            text-align: left;
            padding: 10px 6px;
            font-size: 12px;
            color: #64748b;
            font-weight: 600;
            border-bottom: 1px solid #e2e8f0;
        }
        .preview-table td {
            padding: 12px 6px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }
        .preview-row:hover { background: #f8fafc; }
        .preview-checkbox {
            width: 20px; height: 20px; cursor: pointer;
            accent-color: #1e293b;
        }
        .preview-amount.income { color: #2b7e4b; font-weight: 600; }
        .preview-amount.expense { color: #c83e4d; font-weight: 600; }
        .preview-category {
            background: #e2e8f0; padding: 4px 8px; border-radius: 30px;
            font-size: 11px; display: inline-block;
        }
        .import-actions {
            display: flex; gap: 12px; margin-top: 20px;
            background: white; padding: 16px; border-radius: 40px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.02);
        }
        .import-actions button {
            flex: 1; padding: 16px; border: none; border-radius: 40px;
            font-weight: 600; font-size: 16px; cursor: pointer;
            transition: opacity 0.1s;
        }
        .import-actions button:active { opacity: 0.7; }
        .import-confirm { background: #10b981; color: white; }
        .import-cancel { background: #f1f5f9; color: #475569; }

        .empty-state {
            text-align: center; padding: 48px 16px; color: #94a3b8;
            font-size: 14px; background: #f9fcff; border-radius: 32px;
        }
        .empty-state-small {
            text-align: center; padding: 24px; color: #94a3b8; font-size: 13px;
        }

        .import-section, .chart-container, .category-breakdown, .auto-rule-section {
            background: #f8fafc; border-radius: 28px; padding: 20px; margin-bottom: 16px;
        }
        .import-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
        .import-buttons { display: flex; gap: 12px; margin: 16px 0; }
        .import-btn {
            flex: 1; background: white; border: 2px solid #e2e8f0;
            padding: 14px; border-radius: 40px; font-size: 14px;
            font-weight: 600; color: #334155; display: flex;
            flex-direction: column; align-items: center; gap: 4px;
            cursor: pointer; transition: all 0.1s;
        }
        .import-btn.active { border-color: #1e293b; background: #f1f5f9; }
        .import-btn span:first-child { font-size: 26px; }
        .file-input { display: none; }

        .rule-item { display: flex; gap: 8px; margin: 12px 0; }
        .rule-item input, .rule-item select {
            flex: 1; padding: 12px; border: 1px solid #d1d9e6;
            border-radius: 40px; font-size: 13px;
        }
        .add-rule-btn {
            background: #1e293b; color: white; border: none;
            padding: 14px 20px; border-radius: 40px; font-weight: 600;
            font-size: 14px; width: 100%; margin-top: 12px; cursor: pointer;
        }

        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 16px 0;
        }
        .stat-card {
            background: #f8fafc; border-radius: 24px; padding: 14px 8px; text-align: center;
        }
        .stat-card .label { font-size: 11px; color: #64748b; }
        .stat-card .value { font-size: 18px; font-weight: 700; color: #1e293b; margin-top: 4px; }

        .category-section { background: #f8fafc; border-radius: 28px; padding: 20px; margin-bottom: 16px; }
        .category-header { display: flex; justify-content: space-between; margin-bottom: 16px; }
        .category-header h4 { font-size: 16px; font-weight: 600; color: #1e293b; }
        .category-tabs { display: flex; gap: 8px; }
        .category-tab {
            padding: 6px 16px; border-radius: 40px; font-size: 12px;
            font-weight: 500; background: #e2e8f0; color: #475569;
            cursor: pointer; transition: all 0.1s;
        }
        .category-tab.active { background: #1e293b; color: white; }

        .category-item {
            display: flex; align-items: center; margin: 12px 0; font-size: 13px;
        }
        .category-name { width: 70px; font-weight: 500; }
        .category-bar-container { flex: 1; margin: 0 10px; }
        .category-bar-bg {
            height: 24px; background: #e2e8f0; border-radius: 30px; overflow: hidden;
        }
        .category-bar-fill {
            height: 100%; background: linear-gradient(90deg, #3b82f6, #2563eb);
            border-radius: 30px; width: 0%; transition: width 0.3s;
        }
        .category-amount {
            width: 80px; text-align: right; font-weight: 600; color: #1e293b;
        }
        .category-percent { font-size: 11px; color: #64748b; margin-left: 4px; }

        .chart-container { background: #f8fafc; border-radius: 28px; padding: 20px; }
        .chart-bar-container { margin: 12px 0; }
        .chart-bar-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; }
        .chart-bar-bg {
            height: 20px; background: #e2e8f0; border-radius: 30px; overflow: hidden;
        }
        .chart-bar-fill { height: 100%; background: #1e293b; border-radius: 30px; width: 0%; }

        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.2); backdrop-filter: blur(10px);
            display: none; align-items: center; justify-content: center; z-index: 1000;
            padding: 20px;
        }
        .drawer {
            background: white; max-width: 400px; width: 100%;
            border-radius: 48px; padding: 28px 24px;
        }
        .type-toggle { display: flex; gap: 12px; margin-bottom: 20px; }
        .type-btn {
            flex: 1; background: #ecf1f7; border: none; padding: 16px;
            border-radius: 40px; font-size: 16px; font-weight: 600;
            color: #2d3f55; cursor: pointer; transition: all 0.1s;
        }
        .type-btn.active { background: #1e293b; color: white; }
        .input-field { margin-bottom: 20px; }
        .input-field label { font-size: 14px; font-weight: 500; color: #475569; margin-bottom: 6px; display: block; }
        .input-field input, .input-field select {
            width: 100%; padding: 16px 18px; font-size: 15px;
            background: #f1f5f9; border: none; border-radius: 40px; outline: none;
        }
        .drawer-actions { display: flex; gap: 12px; margin-top: 24px; }
        .drawer-actions button {
            flex: 1; padding: 16px; border: none; border-radius: 40px;
            font-size: 16px; font-weight: 600; cursor: pointer;
        }
        .drawer-actions button.primary { background: #1e293b; color: white; }
    </style>
</head>
<body>
<div class="phone-frame">
    <!-- çŠ¶æ€æ  -->
    <div class="status-bar">
        <div class="current-date" id="currentDateDisplay">2025å¹´3æœˆ21æ—¥ å‘¨äº”</div>
        <div class="user-profile">
            <div class="avatar" id="avatarBtn">ğŸ‘¤</div>
        </div>
    </div>

    <!-- ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡† -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-card">
            <div class="auth-tabs">
                <div class="auth-tab active" id="loginTab">ç™»å½•</div>
                <div class="auth-tab" id="registerTab">æ³¨å†Œ</div>
            </div>
            <div id="loginForm">
                <input type="text" class="auth-input" id="loginUsername" placeholder="ç”¨æˆ·å">
                <input type="password" class="auth-input" id="loginPassword" placeholder="å¯†ç ">
                <button class="auth-btn" id="loginBtn">ç™»å½•</button>
            </div>
            <div id="registerForm" style="display: none;">
                <input type="text" class="auth-input" id="registerUsername" placeholder="ç”¨æˆ·å">
                <input type="password" class="auth-input" id="registerPassword" placeholder="å¯†ç ">
                <input type="password" class="auth-input" id="registerConfirm" placeholder="ç¡®è®¤å¯†ç ">
                <button class="auth-btn" id="registerBtn">æ³¨å†Œ</button>
            </div>
            <button class="auth-btn logout-btn" id="logoutBtn" style="display: none;">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="tab-bar" id="tabBar">
        <div class="tab active" data-tab="home">ğŸ“± è®°è´¦</div>
        <div class="tab" data-tab="import">ğŸ“¥ å¯¼å…¥</div>
        <div class="tab" data-tab="reports">ğŸ“Š æŠ¥è¡¨</div>
        <div class="tab" data-tab="rules">âš™ï¸ è§„åˆ™</div>
    </div>

    <!-- é¦–é¡µ - è®°è´¦ -->
    <div class="tab-content active" id="homeTab">
        <div class="page-container">
            <div class="app-title">ğŸ’° æ™ºèƒ½è®°è´¦</div>
            <div class="welcome-message" id="welcomeMessage">ğŸ‘‹ æ¬¢è¿ï¼Œæ¸¸å®¢</div>
            <div class="balance-card">
                <div class="balance-row">
                    <div class="balance-item">
                        <div class="balance-label">å½“å‰æ”¶å…¥</div>
                        <div class="balance-value income" id="currentIncome">Â¥0.00</div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-label">å½“å‰æ”¯å‡º</div>
                        <div class="balance-value expense" id="currentExpense">Â¥0.00</div>
                    </div>
                </div>
            </div>
            <div class="time-range-selector">
                <select id="timeRangeSelect">
                    <option value="day">ğŸ“… æ—¥</option>
                    <option value="week">ğŸ“† å‘¨</option>
                    <option value="month">ğŸ“Š æœˆ</option>
                    <option value="quarter">ğŸ“ˆ å­£åº¦</option>
                    <option value="year">ğŸ“‰ å¹´</option>
                    <option value="custom">âœï¸ è‡ªå®šä¹‰</option>
                </select>
            </div>
            <div class="custom-date-range" id="customDateRange" style="display: none;">
                <input type="date" class="date-input" id="startDate">
                <span>è‡³</span>
                <input type="date" class="date-input" id="endDate">
                <button class="query-btn" id="queryCustomBtn">æŸ¥è¯¢</button>
            </div>
            <div class="range-summary" id="rangeStats">
                <div class="summary-box"><div class="summary-label">æ”¶å…¥</div><div class="summary-number" id="rangeIncome">Â¥0</div></div>
                <div class="summary-box"><div class="summary-label">æ”¯å‡º</div><div class="summary-number" id="rangeExpense">Â¥0</div></div>
                <div class="summary-box"><div class="summary-label">ç»“ä½™</div><div class="summary-number" id="rangeBalance">Â¥0</div></div>
                <div class="summary-box"><div class="summary-label">ç¬”æ•°</div><div class="summary-number" id="rangeCount">0</div></div>
            </div>
            <div class="quick-add">
                <span>è®°ä¸€ç¬”æ–°è´¦</span>
                <button class="add-btn" id="showAddDrawer">+</button>
            </div>
            <div class="filter-row" id="filterRow">
                <span class="filter-chip active" data-filter="all">å…¨éƒ¨</span>
                <span class="filter-chip" data-filter="é¤é¥®">ğŸœ é¤é¥®</span>
                <span class="filter-chip" data-filter="è´­ç‰©">ğŸ›ï¸ è´­ç‰©</span>
                <span class="filter-chip" data-filter="äº¤é€š">ğŸš— äº¤é€š</span>
                <span class="filter-chip" data-filter="å¨±ä¹">ğŸ® å¨±ä¹</span>
                <span class="filter-chip" data-filter="å·¥èµ„">ğŸ’¼ å·¥èµ„</span>
                <span class="filter-chip" data-filter="å…¶ä»–">ğŸ“¦ å…¶ä»–</span>
            </div>
            <div class="list-container">
                <ul class="transactions-list" id="transactionList">
                    <div class="empty-state">ğŸ“­ è¿˜æ²¡æœ‰è®°è´¦è®°å½•<br>ç‚¹å‡»ä¸‹æ–¹â•å¼€å§‹è®°è´¦å§</div>
                </ul>
            </div>
        </div>
    </div>

    <!-- å¯¼å…¥é¡µé¢ - å¢å¼ºç‰ˆ -->
    <div class="tab-content" id="importTab">
        <div class="page-container">
            <div class="app-title">ğŸ“¥ å¯¼å…¥è´¦å•</div>
            <div class="welcome-message">æ”¯æŒå¾®ä¿¡ xlsx / æ”¯ä»˜å® csv</div>
            <div class="import-section">
                <div class="import-title">ğŸ“ 1. é€‰æ‹©è´¦å•æ¥æº</div>
                <div class="import-buttons">
                    <div class="import-btn active" id="wechatBtn"><span>ğŸ’¬</span><span>å¾®ä¿¡</span><span style="font-size:10px;">.xlsx</span></div>
                    <div class="import-btn" id="alipayBtn"><span>ğŸ’°</span><span>æ”¯ä»˜å®</span><span style="font-size:10px;">.csv</span></div>
                </div>
            </div>
            <div class="import-section">
                <div class="import-title">ğŸ“ 2. é€‰æ‹©æ–‡ä»¶</div>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv,.txt">
                <button class="add-rule-btn" id="parseBtn" style="background:#10b981;">ğŸ“¤ é€‰æ‹©å¹¶è§£ææ–‡ä»¶</button>
            </div>
            <div class="import-section">
                <div class="import-title">ğŸ“ 3. é¢„è§ˆä¸é€‰æ‹©</div>
                <div class="import-preview" id="importPreview">
                    <div class="empty-state-small">é€‰æ‹©æ–‡ä»¶åï¼Œæ‰€æœ‰è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œï¼Œå¯å‹¾é€‰éœ€è¦å¯¼å…¥çš„æ¡ç›®</div>
                </div>
                <!-- å…¨é€‰å’Œæ“ä½œæŒ‰é’®ä¼šåŠ¨æ€æ’å…¥åˆ°é¢„è§ˆåŒºå†… -->
            </div>
            <div class="auto-rule-section">
                <div style="font-weight:600; margin-bottom:8px;">ğŸ¤– æ™ºèƒ½åˆ†ç±»åŒ¹é…</div>
                <div id="autoCategoryPreview" style="font-size:13px; color:#64748b; min-height:40px;">è§£æåæ˜¾ç¤ºåŒ¹é…ç»“æœ</div>
            </div>
        </div>
    </div>

    <!-- æŠ¥è¡¨é¡µé¢ -->
    <div class="tab-content" id="reportsTab">
        <div class="page-container">
            <div class="app-title">ğŸ“Š æ•°æ®æŠ¥è¡¨</div>
            <div class="welcome-message" id="reportMonth">æœ¬æœˆç»Ÿè®¡</div>
            <div class="stats-grid">
                <div class="stat-card"><div class="label">æ€»æ”¯å‡º</div><div class="value" id="totalExpense">Â¥0</div></div>
                <div class="stat-card"><div class="label">æ€»æ”¶å…¥</div><div class="value" id="totalIncome">Â¥0</div></div>
                <div class="stat-card"><div class="label">ç»“ä½™</div><div class="value" id="totalBalance">Â¥0</div></div>
                <div class="stat-card"><div class="label">äº¤æ˜“ç¬”æ•°</div><div class="value" id="txCount">0</div></div>
                <div class="stat-card"><div class="label">æ—¥å‡æ”¯å‡º</div><div class="value" id="dailyAvg">Â¥0</div></div>
                <div class="stat-card"><div class="label">æœ€å¤§å•ç¬”</div><div class="value" id="maxExpense">Â¥0</div></div>
            </div>
            <div class="category-section">
                <div class="category-header">
                    <h4>ğŸ“Š åˆ†ç±»ç»Ÿè®¡</h4>
                    <div class="category-tabs"><span class="category-tab active" data-category="expense">æ”¯å‡º</span><span class="category-tab" data-category="income">æ”¶å…¥</span></div>
                </div>
                <div id="expenseCategoryChart"></div>
                <div id="incomeCategoryChart" style="display:none;"></div>
            </div>
            <div class="chart-container">
                <div style="font-weight:600; margin-bottom:10px;">ğŸ“ˆ æ”¯å‡ºè¶‹åŠ¿ï¼ˆè¿‘7å¤©ï¼‰</div>
                <div id="trendChart"><div class="empty-state-small">æš‚æ— æ•°æ®</div></div>
            </div>
        </div>
    </div>

    <!-- è§„åˆ™é¡µé¢ -->
    <div class="tab-content" id="rulesTab">
        <div class="page-container">
            <div class="app-title">âš™ï¸ åˆ†ç±»è§„åˆ™</div>
            <div class="welcome-message">è®¾ç½®æ™ºèƒ½åˆ†ç±»å…³é”®è¯</div>
            <div class="import-section">
                <div class="import-title">ğŸ“‹ å½“å‰è§„åˆ™</div>
                <div id="rulesList" style="max-height:180px; overflow-y:auto; margin-bottom:12px;"></div>
                <div class="rule-item">
                    <input type="text" id="newRuleKeyword" placeholder="å…³é”®è¯ (å¦‚: æ˜Ÿå·´å…‹)">
                    <select id="newRuleCategory">
                        <option value="é¤é¥®">ğŸœ é¤é¥®</option>
                        <option value="è´­ç‰©">ğŸ›ï¸ è´­ç‰©</option>
                        <option value="äº¤é€š">ğŸš— äº¤é€š</option>
                        <option value="å¨±ä¹">ğŸ® å¨±ä¹</option>
                        <option value="å…¶ä»–">ğŸ“¦ å…¶ä»–</option>
                    </select>
                </div>
                <button class="add-rule-btn" id="addRuleBtn">â• æ·»åŠ è§„åˆ™</button>
            </div>
            <div class="auto-rule-section">
                <div style="font-weight:600; margin-bottom:4px;">ğŸ’¡ ä½¿ç”¨è¯´æ˜</div>
                <div style="font-size:12px; color:#64748b;">å¯¼å…¥è´¦å•æ—¶ï¼Œæ ¹æ®å•†æˆ·åç§°è‡ªåŠ¨åŒ¹é…åˆ†ç±»<br>ä¾‹å¦‚ï¼šåŒ…å«"æ˜Ÿå·´å…‹"è‡ªåŠ¨å½’ç±»ä¸ºé¤é¥®</div>
            </div>
        </div>
    </div>

    <!-- è®°è´¦æŠ½å±‰ -->
    <div class="overlay" id="drawerOverlay">
        <div class="drawer">
            <h2 style="font-size:22px; margin-bottom:16px;">ğŸ“ æ–°å»ºè´¦å•</h2>
            <div class="type-toggle">
                <button class="type-btn active" id="expenseTypeBtn">ğŸ’¸ æ”¯å‡º</button>
                <button class="type-btn" id="incomeTypeBtn">ğŸ’° æ”¶å…¥</button>
            </div>
            <div class="input-field"><label>é‡‘é¢ (Â¥)</label><input type="number" id="amountInput" placeholder="0.00" step="0.01"></div>
            <div class="input-field"><label>åˆ†ç±»</label>
                <select id="categorySelect">
                    <option value="é¤é¥®">ğŸœ é¤é¥®</option><option value="è´­ç‰©">ğŸ›ï¸ è´­ç‰©</option>
                    <option value="äº¤é€š">ğŸš— äº¤é€š</option><option value="å¨±ä¹">ğŸ® å¨±ä¹</option>
                    <option value="å·¥èµ„">ğŸ’¼ å·¥èµ„</option><option value="å…¶ä»–">ğŸ“¦ å…¶ä»–</option>
                </select>
            </div>
            <div class="input-field"><label>å•†æˆ·/å¤‡æ³¨</label><input type="text" id="descInput" placeholder="ä¾‹å¦‚: æ˜Ÿå·´å…‹"></div>
            <div class="drawer-actions"><button id="cancelDrawer">å–æ¶ˆ</button><button class="primary" id="saveTransaction">ä¿å­˜</button></div>
        </div>
    </div>
</div>

<script>
    (function() {
        document.addEventListener('DOMContentLoaded', function() { initApp(); });

        function initApp() {
            let currentUser = null;
            const USERS_KEY = 'app_users';
            const SESSION_KEY = 'current_session';
            let transactions = [], rules = [], currentFilter = 'all', currentTimeRange = 'day';
            let customStartDate = '', customEndDate = '', currentCategoryTab = 'expense';
            let currentImportType = 'wechat', previewRecords = [];

            initUserSystem();

            function initUserSystem() {
                const session = localStorage.getItem(SESSION_KEY);
                if (session) try { currentUser = JSON.parse(session); } catch(e) { currentUser = null; }
                if (!localStorage.getItem(USERS_KEY)) localStorage.setItem(USERS_KEY, JSON.stringify({}));
                updateDateTime(); setInterval(updateDateTime,1000);
                if (currentUser) { updateUIForUser(); loadUserData(); } else { loadGuestData(); }
            }

            function updateDateTime() {
                const now = new Date(), y=now.getFullYear(), m=now.getMonth()+1, d=now.getDate();
                const w = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'][now.getDay()];
                const el = document.getElementById('currentDateDisplay');
                if(el) el.textContent = `${y}å¹´${m}æœˆ${d}æ—¥ ${w}`;
            }

            function updateUIForUser() {
                const a = document.getElementById('avatarBtn'), w=document.getElementById('welcomeMessage'), l=document.getElementById('logoutBtn');
                if (currentUser) {
                    if(a) a.textContent = currentUser.username[0].toUpperCase();
                    if(w) w.textContent = `ğŸ‘‹ æ¬¢è¿ï¼Œ${currentUser.username}`;
                    if(l) l.style.display = 'block';
                    document.getElementById('loginForm').style.display='none';
                    document.getElementById('registerForm').style.display='none';
                    document.getElementById('loginTab').style.display='none';
                    document.getElementById('registerTab').style.display='none';
                } else {
                    if(a) a.textContent='ğŸ‘¤'; if(w) w.textContent='ğŸ‘‹ æ¬¢è¿ï¼Œæ¸¸å®¢'; if(l) l.style.display='none';
                    document.getElementById('loginForm').style.display='block';
                    document.getElementById('registerForm').style.display='none';
                    document.getElementById('loginTab').style.display='block';
                    document.getElementById('registerTab').style.display='block';
                    document.getElementById('loginTab').classList.add('active');
                    document.getElementById('registerTab').classList.remove('active');
                }
            }

            function getUserStorageKey() { return currentUser ? `user_data_${currentUser.username}` : 'guest_data'; }

            function loadGuestData() { transactions=[]; rules=getDefaultRules(); updateAll(); }
            function loadUserData() {
                const key = getUserStorageKey(), stored = localStorage.getItem(key);
                if (stored) try { const d=JSON.parse(stored); transactions=d.transactions||[]; rules=d.rules||getDefaultRules(); } catch(e){ transactions=[]; rules=getDefaultRules(); }
                else { transactions=[]; rules=getDefaultRules(); }
                updateAll();
            }
            function saveUserData() { localStorage.setItem(getUserStorageKey(), JSON.stringify({transactions,rules})); }

            function getDefaultRules() { return [
                {keyword:'æ˜Ÿå·´å…‹',category:'é¤é¥®'},{keyword:'éº¦å½“åŠ³',category:'é¤é¥®'},{keyword:'è‚¯å¾·åŸº',category:'é¤é¥®'},
                {keyword:'æ»´æ»´',category:'äº¤é€š'},{keyword:'åœ°é“',category:'äº¤é€š'},{keyword:'æ·˜å®',category:'è´­ç‰©'},
                {keyword:'äº¬ä¸œ',category:'è´­ç‰©'},{keyword:'ç¾å›¢',category:'é¤é¥®'},{keyword:'é¥¿äº†ä¹ˆ',category:'é¤é¥®'}
            ];}

            function getToday() { return new Date().toISOString().slice(0,10); }

            function getDateRangeFromType(rangeType) {
                const now = new Date(), y=now.getFullYear(), m=now.getMonth(), d=now.getDate();
                let start, end;
                switch(rangeType) {
                    case 'day': start=new Date(y,m,d); end=new Date(y,m,d,23,59,59); break;
                    case 'week': const fd=new Date(y,m,d-now.getDay()); start=new Date(fd.getFullYear(),fd.getMonth(),fd.getDate()); end=new Date(y,m,d,23,59,59); break;
                    case 'month': start=new Date(y,m,1); end=new Date(y,m+1,0,23,59,59); break;
                    case 'quarter': const qm=Math.floor(m/3)*3; start=new Date(y,qm,1); end=new Date(y,qm+3,0,23,59,59); break;
                    case 'year': start=new Date(y,0,1); end=new Date(y,11,31,23,59,59); break;
                    default: return {start:null,end:null};
                }
                return {start:start.toISOString().slice(0,10), end:end.toISOString().slice(0,10)};
            }

            function filterTransactionsByDateRange(rangeType,customStart,customEnd) {
                let startDate,endDate;
                if (rangeType==='custom' && customStart && customEnd) { startDate=customStart; endDate=customEnd; }
                else { const r=getDateRangeFromType(rangeType); startDate=r.start; endDate=r.end; }
                if (!startDate||!endDate) return transactions||[];
                return (transactions||[]).filter(t => t.date>=startDate && t.date<=endDate);
            }

            function updateCurrentIncomeExpense() {
                const f = filterTransactionsByDateRange(currentTimeRange,customStartDate,customEndDate);
                let inc=0, exp=0; f.forEach(t=>{if(t.type==='income') inc+=t.amount; else exp+=t.amount;});
                const ie=document.getElementById('currentIncome'), ee=document.getElementById('currentExpense');
                if(ie) ie.textContent='Â¥'+inc.toFixed(2); if(ee) ee.textContent='Â¥'+exp.toFixed(2);
            }

            function updateRangeStats() {
                const f = filterTransactionsByDateRange(currentTimeRange,customStartDate,customEndDate);
                let inc=0, exp=0; f.forEach(t=>{if(t.type==='income') inc+=t.amount; else exp+=t.amount;});
                document.getElementById('rangeIncome').textContent='Â¥'+inc.toFixed(2);
                document.getElementById('rangeExpense').textContent='Â¥'+exp.toFixed(2);
                document.getElementById('rangeBalance').textContent='Â¥'+(inc-exp).toFixed(2);
                document.getElementById('rangeCount').textContent=f.length;
            }

            window.queryCustomRange = function() {
                const s=document.getElementById('startDate').value, e=document.getElementById('endDate').value;
                if(!s||!e){ alert('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ'); return; }
                customStartDate=s; customEndDate=e; currentTimeRange='custom';
                document.getElementById('timeRangeSelect').value='custom';
                updateCurrentIncomeExpense(); updateRangeStats(); renderFilteredList();
            };

            function renderFilteredList() {
                let f = filterTransactionsByDateRange(currentTimeRange,customStartDate,customEndDate);
                if(currentFilter!=='all') f = f.filter(t=>t.category===currentFilter);
                const sorted = [...f].sort((a,b)=>a.date>b.date?-1:1);
                const listEl=document.getElementById('transactionList');
                if(sorted.length===0) { listEl.innerHTML='<div class="empty-state">ğŸ“­ å½“å‰æ—¶é—´èŒƒå›´æ— è®°å½•<br>ç‚¹å‡»ä¸‹æ–¹â•å¼€å§‹è®°è´¦å§</div>'; return; }
                let html='';
                sorted.forEach(tx=>{
                    const icon = tx.category==='é¤é¥®'?'ğŸœ':tx.category==='è´­ç‰©'?'ğŸ›ï¸':tx.category==='äº¤é€š'?'ğŸš—':tx.category==='å¨±ä¹'?'ğŸ®':tx.category==='å·¥èµ„'?'ğŸ’¼':'ğŸ“¦';
                    html+=`<li data-id="${tx.id}"><div class="tx-left"><div class="tx-cat-icon">${icon}</div><div class="tx-info"><span class="tx-desc">${tx.description||(tx.type==='income'?'æ”¶å…¥':'æ”¯å‡º')}</span><span class="tx-merchant">${tx.merchant||''}</span></div></div><div class="tx-right"><span class="tx-amount ${tx.type}">${tx.type==='income'?'+':'-'}Â¥${tx.amount.toFixed(2)}</span><span class="tx-date">${tx.date}</span></div><button class="delete-tx" data-id="${tx.id}">âœ•</button></li>`;
                });
                listEl.innerHTML=html;
                document.querySelectorAll('.delete-tx').forEach(btn=>btn.addEventListener('click',function(e){e.stopPropagation(); transactions=transactions.filter(t=>t.id!==Number(this.dataset.id)); saveUserData(); updateAll();}));
            }

            function smartCategorize(merchant,desc) { const text=(merchant+' '+desc).toLowerCase(); for(let r of rules) if(text.includes(r.keyword.toLowerCase())) return r.category; return 'å…¶ä»–'; }

            // ========== å¯¼å…¥åŠŸèƒ½ ==========
            async function parseWechatXLSX(file) {
                return new Promise((resolve,reject)=>{
                    const reader=new FileReader();
                    reader.onload=e=>{
                        try {
                            const data=new Uint8Array(e.target.result), wb=XLSX.read(data,{type:'array'}), ws=wb.Sheets[wb.SheetNames[0]];
                            const json=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
                            let headerRow=-1;
                            for(let i=0;i<json.length;i++){ const r=json[i]; if(r&&r.length>0&&(r.join('|').toLowerCase().includes('äº¤æ˜“æ—¶é—´')||r.join('|').toLowerCase().includes('äº¤æ˜“ç±»å‹'))){ headerRow=i; break; } }
                            if(headerRow===-1) throw new Error('æœªæ‰¾åˆ°è¡¨å¤´');
                            const headers=json[headerRow];
                            let dateCol=-1,typeCol=-1,amountCol=-1,merchantCol=-1;
                            headers.forEach((h,i)=>{ const l=String(h||'').toLowerCase(); if(l.includes('äº¤æ˜“æ—¶é—´')) dateCol=i; if(l.includes('æ”¶/æ”¯')||l.includes('æ”¶æ”¯')) typeCol=i; if(l.includes('é‡‘é¢')) amountCol=i; if(l.includes('äº¤æ˜“å¯¹æ–¹')) merchantCol=i; });
                            const records=[];
                            for(let i=headerRow+1;i<json.length;i++){
                                const row=json[i]; if(!row||row.length===0) continue;
                                try {
                                    let date=parseDate(String(row[dateCol]||''));
                                    if(!date && typeof row[dateCol]==='number') date=new Date((row[dateCol]-25569)*86400*1000).toISOString().slice(0,10);
                                    if(!date) continue;
                                    let amount=parseAmount(String(row[amountCol]||'')); if(amount<=0) continue;
                                    const isIncome=String(row[typeCol]||'').includes('æ”¶å…¥')||String(row[typeCol]||'').includes('å­˜å…¥');
                                    const merchant=String(row[merchantCol]||'').trim()||'æœªçŸ¥';
                                    records.push({date,type:isIncome?'income':'expense',amount,merchant,description:''});
                                } catch(err){ console.warn(err); }
                            }
                            resolve(records);
                        } catch(err){ reject(err); }
                    };
                    reader.onerror=reject;
                    reader.readAsArrayBuffer(file);
                });
            }

            function parseAlipayCSV(text) {
                console.log('è§£ææ”¯ä»˜å®CSV');
                const records=[], lines=text.split('\n');
                let headerRow=-1, headers=[];
                for(let i=0;i<Math.min(30,lines.length);i++){
                    const line=lines[i].trim(); if(!line) continue;
                    let matchCount=0; ['äº¤æ˜“æ—¶é—´','æ—¶é—´','æ—¥æœŸ','é‡‘é¢','æ”¶/æ”¯','æ”¶æ”¯','äº¤æ˜“å¯¹æ–¹','å¯¹æ–¹','å•†æˆ·','å•†å“è¯´æ˜'].forEach(k=>{if(line.includes(k)) matchCount++;});
                    if(matchCount>=3){ headerRow=i; headers=parseCSVLine(line); break; }
                }
                if(headerRow===-1 && lines.length>0){ headerRow=0; headers=parseCSVLine(lines[0]); }
                if(headerRow===-1) return records;
                headers=headers.map(h=>String(h||'').replace(/["']/g,'').trim());
                let dateCol=-1,typeCol=-1,amountCol=-1,merchantCol=-1;
                headers.forEach((h,i)=>{ const l=h.toLowerCase();
                    if(l.includes('äº¤æ˜“æ—¶é—´')||l.includes('æ—¶é—´')||l.includes('æ—¥æœŸ')) dateCol=i;
                    if(l.includes('æ”¶/æ”¯')||l.includes('æ”¶æ”¯')||l==='æ”¶/æ”¯') typeCol=i;
                    if(l.includes('é‡‘é¢')||l.includes('ä»·é’±')||l.includes('ä»·æ ¼')) amountCol=i;
                    if(l.includes('äº¤æ˜“å¯¹æ–¹')||l.includes('å¯¹æ–¹')||l.includes('å•†æˆ·')||l.includes('å•†å“è¯´æ˜')||l.includes('å•†å“åç§°')) merchantCol=i;
                });
                if(typeCol===-1) headers.forEach((h,i)=>{ const l=h.toLowerCase(); if(l.includes('æ”¶å…¥')||l.includes('æ”¯å‡º')) typeCol=i; });
                if(dateCol===-1||amountCol===-1) return parseAlipayFallback(lines);
                for(let i=headerRow+1;i<lines.length;i++){
                    const line=lines[i].trim(); if(!line) continue;
                    try {
                        const fields=parseCSVLine(line).map(f=>String(f||'').replace(/^"|"$/g,'').trim());
                        if(fields.length<3) continue;
                        const date=parseDateFlexible(dateCol>=0&&dateCol<fields.length?fields[dateCol]:'');
                        if(!date) continue;
                        let amount=parseAmountFlexible(amountCol>=0&&amountCol<fields.length?fields[amountCol]:''); if(amount<=0) continue;
                        let isIncome=false;
                        if(typeCol>=0&&typeCol<fields.length) { const ts=fields[typeCol].toLowerCase(); isIncome=ts.includes('æ”¶å…¥')||ts.includes('é€€æ¬¾')||ts.includes('+')||ts.includes('æ”¶æ¬¾'); }
                        else isIncome=!fields[amountCol].includes('-');
                        let merchant='æœªçŸ¥';
                        if(merchantCol>=0&&merchantCol<fields.length) merchant=fields[merchantCol];
                        else if(fields.length>2) merchant=fields[2];
                        merchant=merchant.replace(/\s+/g,' ').trim()||'æœªçŸ¥';
                        records.push({date,type:isIncome?'income':'expense',amount,merchant:merchant.substring(0,30),description:''});
                    } catch(err){ console.warn(err); }
                }
                return records;
            }

            function parseAlipayFallback(lines) {
                const records=[];
                for(let i=1;i<lines.length;i++){
                    const line=lines[i].trim(); if(!line) continue;
                    try {
                        const dateMatch=line.match(/(\d{4})[-/](\d{1,2})[-/](\d{1,2})/); if(!dateMatch) continue;
                        const y=dateMatch[1], m=dateMatch[2].padStart(2,'0'), d=dateMatch[3].padStart(2,'0'), date=`${y}-${m}-${d}`;
                        const amountMatches=line.match(/[+-]?[\d,]+\.\d{2}/g); if(!amountMatches) continue;
                        const amount=Math.abs(parseFloat(amountMatches[amountMatches.length-1].replace(/,/g,''))); if(isNaN(amount)||amount<=0) continue;
                        const isIncome=line.includes('æ”¶å…¥')||line.includes('é€€æ¬¾')||line.includes('+');
                        let merchant='æœªçŸ¥';
                        const parts=line.split(','); for(let p of parts){ p=p.trim(); if(p&&p.length>1&&p.length<20&&!p.includes('äº¤æ˜“')&&!p.includes('é‡‘é¢')&&!p.match(/\d{4}[-/]/)&&!p.match(/[\d,]+\.\d{2}/)){ merchant=p.replace(/["']/g,'').trim(); break; } }
                        records.push({date,type:isIncome?'income':'expense',amount,merchant:merchant||'æœªçŸ¥',description:''});
                    } catch(err){}
                }
                return records;
            }

            function parseCSVLine(line){
                const f=[]; let field='', inQ=false;
                for(let i=0;i<line.length;i++){
                    const c=line[i], n=line[i+1];
                    if(c==='"'&&!inQ) inQ=true;
                    else if(c==='"'&&inQ){ if(n==='"'){ field+='"'; i++; } else inQ=false; }
                    else if(c===','&&!inQ){ f.push(field); field=''; }
                    else field+=c;
                }
                f.push(field);
                return f;
            }
            function parseAmount(s){ if(!s) return 0; let m=String(s).replace(/["'Â¥$]/g,'').replace(/,/g,'').match(/-?[\d.]+/); return m?Math.abs(parseFloat(m[0]))||0:0; }
            function parseDate(s){ if(!s) return null; let m=String(s).replace(/["']/g,'').match(/(\d{4})[-/](\d{1,2})[-/](\d{1,2})/); return m?`${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`:null; }
            function parseDateFlexible(s){
                if(!s) return null;
                let c=String(s).replace(/["']/g,'').trim();
                let m=c.match(/(\d{4})[-/](\d{1,2})[-/](\d{1,2})/);
                if(m) return `${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`;
                m=c.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
                if(m) return `${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`;
                m=c.match(/(\d{1,2})[/](\d{1,2})[/](\d{4})/);
                if(m) return `${m[3]}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}`;
                return null;
            }
            function parseAmountFlexible(s){ if(!s) return 0; let m=String(s).replace(/["'Â¥$]/g,'').replace(/,/g,'').match(/-?[\d.]+/); return m?Math.abs(parseFloat(m[0]))||0:0; }
            function containsMoji(s){ return s.includes('ï¿½'); }

            // æ–°ç‰ˆé¢„è§ˆï¼šæ˜¾ç¤ºå…¨éƒ¨è®°å½•ï¼Œå¸¦å¤é€‰æ¡†
            function displayImportPreview(records, duplicateCount) {
                if (records.length === 0) {
                    document.getElementById('importPreview').innerHTML = '<div class="empty-state-small">æœªæ‰¾åˆ°æœ‰æ•ˆçš„äº¤æ˜“è®°å½•</div>';
                    return;
                }
                let totalIncome = 0, totalExpense = 0, incomeCount = 0, expenseCount = 0;
                const categoryCount = {};
                records.forEach(r => {
                    if (r.type === 'income') { totalIncome += r.amount; incomeCount++; }
                    else { totalExpense += r.amount; expenseCount++; }
                    const cat = smartCategorize(r.merchant, r.description);
                    categoryCount[cat] = (categoryCount[cat]||0) + 1;
                });

                let tableHtml = `
                    <div style="margin-bottom:16px; background:#f1f5f9; padding:16px; border-radius:28px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <span style="font-weight:600;">âœ… è§£ææˆåŠŸ: ${records.length} æ¡</span>
                            <span>
                                <label style="margin-right:12px; cursor:pointer;">
                                    <input type="checkbox" id="selectAllCheckbox" style="accent-color:#1e293b; width:18px; height:18px; vertical-align:middle; margin-right:6px;">å…¨é€‰
                                </label>
                            </span>
                        </div>
                        <div style="font-size:14px;">æ”¶å…¥: ${incomeCount}ç¬” Â¥${totalIncome.toFixed(2)}  æ”¯å‡º: ${expenseCount}ç¬” Â¥${totalExpense.toFixed(2)}</div>
                    </div>
                    <table class="preview-table">
                        <thead><tr><th style="width:30px;"></th><th>æ—¥æœŸ</th><th>å•†æˆ·</th><th>é‡‘é¢</th><th>åˆ†ç±»</th></tr></thead>
                        <tbody>
                `;
                records.forEach((rec, idx) => {
                    const category = smartCategorize(rec.merchant, rec.description);
                    tableHtml += `
                        <tr class="preview-row">
                            <td><input type="checkbox" class="preview-checkbox" data-index="${idx}" checked></td>
                            <td>${rec.date}</td>
                            <td>${rec.merchant}</td>
                            <td class="preview-amount ${rec.type}">${rec.type==='income'?'+':'-'}Â¥${rec.amount.toFixed(2)}</td>
                            <td><span class="preview-category">${category}</span></td>
                        </tr>
                    `;
                });
                tableHtml += `</tbody></table>`;

                let categoryHtml = '<div style="margin-top:16px; background:#f1f5f9; padding:16px; border-radius:28px;"><div style="font-weight:600; margin-bottom:8px;">ğŸ“Š åˆ†ç±»ç»Ÿè®¡</div>';
                Object.entries(categoryCount).forEach(([cat, cnt]) => {
                    const percent = ((cnt / records.length) * 100).toFixed(1);
                    categoryHtml += `<span style="background:#e2e8f0; padding:6px 12px; border-radius:40px; margin:4px; display:inline-block; font-size:12px;">${cat} ${cnt}ç¬” (${percent}%)</span>`;
                });
                categoryHtml += '</div>';

                // æ“ä½œæŒ‰é’®
                const actionsHtml = `
                    <div class="import-actions">
                        <button class="import-confirm" id="confirmImportBtn">ç¡®è®¤å¯¼å…¥é€‰ä¸­ (${records.length})</button>
                        <button class="import-cancel" id="cancelImportBtn">å–æ¶ˆ</button>
                    </div>
                `;

                document.getElementById('importPreview').innerHTML = tableHtml + categoryHtml + actionsHtml;
                document.getElementById('autoCategoryPreview').innerHTML = '';

                // å…¨é€‰é€»è¾‘
                const selectAll = document.getElementById('selectAllCheckbox');
                const checkboxes = document.querySelectorAll('.preview-checkbox');
                if (selectAll) {
                    selectAll.addEventListener('change', (e) => {
                        checkboxes.forEach(cb => cb.checked = e.target.checked);
                    });
                }

                // ç¡®è®¤å¯¼å…¥ï¼šæ”¶é›†é€‰ä¸­çš„ç´¢å¼•
                document.getElementById('confirmImportBtn').addEventListener('click', () => {
                    const selectedIndices = [];
                    checkboxes.forEach((cb, i) => { if (cb.checked) selectedIndices.push(i); });
                    const selectedRecords = selectedIndices.map(i => records[i]);
                    if (selectedRecords.length === 0) { alert('è¯·è‡³å°‘é€‰æ‹©ä¸€æ¡è®°å½•'); return; }
                    confirmImportSelected(selectedRecords);
                });

                document.getElementById('cancelImportBtn').addEventListener('click', () => {
                    previewRecords = null;
                    document.getElementById('fileInput').value = '';
                    document.getElementById('importPreview').innerHTML = '<div class="empty-state-small">å·²å–æ¶ˆå¯¼å…¥</div>';
                    document.getElementById('autoCategoryPreview').innerHTML = '';
                });
            }

            function confirmImportSelected(selectedRecords) {
                if (selectedRecords.length === 0) return;
                let success = 0, skip = 0;
                selectedRecords.forEach(rec => {
                    const exists = transactions.some(t => t.date === rec.date && Math.abs(t.amount - rec.amount) < 0.01 && t.merchant === rec.merchant);
                    if (!exists) {
                        const cat = smartCategorize(rec.merchant, rec.description);
                        transactions.push({ id: Date.now() + Math.random(), amount: rec.amount, type: rec.type, category: cat, description: rec.description || (rec.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'), merchant: rec.merchant, date: rec.date });
                        success++;
                    } else skip++;
                });
                saveUserData();
                updateAll();
                alert(`å¯¼å…¥å®Œæˆï¼šæˆåŠŸ ${success} æ¡ï¼Œè·³è¿‡ ${skip} æ¡é‡å¤ã€‚`);
                document.getElementById('importPreview').innerHTML = `<div style="background:#e6f7e6; padding:20px; text-align:center; border-radius:28px;">âœ… æˆåŠŸå¯¼å…¥ ${success} æ¡è®°å½•</div>`;
                previewRecords = null;
                document.getElementById('autoCategoryPreview').innerHTML = '';
            }

            function removeDuplicates(records) { const s=new Set(); return records.filter(r=>{const k=`${r.date}_${r.amount.toFixed(2)}_${r.merchant}_${r.type}`; if(s.has(k)) return false; s.add(k); return true;}); }

            // æŠ¥è¡¨æ¸²æŸ“å‡½æ•°ï¼ˆç•¥ï¼Œä¿æŒåŸæ ·ï¼‰
            function renderReports() {
                const f = filterTransactionsByDateRange('month');
                let te=0, ti=0, max=0; const em={}, im={};
                f.forEach(t=>{
                    if(t.type==='expense'){ te+=t.amount; em[t.category]=(em[t.category]||0)+t.amount; if(t.amount>max) max=t.amount; }
                    else { ti+=t.amount; im[t.category]=(im[t.category]||0)+t.amount; }
                });
                document.getElementById('totalExpense').textContent='Â¥'+te.toFixed(2);
                document.getElementById('totalIncome').textContent='Â¥'+ti.toFixed(2);
                document.getElementById('totalBalance').textContent='Â¥'+(ti-te).toFixed(2);
                document.getElementById('txCount').textContent=f.length;
                document.getElementById('dailyAvg').textContent='Â¥'+(te/30).toFixed(2);
                document.getElementById('maxExpense').textContent='Â¥'+max.toFixed(2);
                renderCategoryChart('expense',em,te);
                renderCategoryChart('income',im,ti);
                renderTrendChart();
            }
            function renderCategoryChart(type,m,total){
                const cid=type==='expense'?'expenseCategoryChart':'incomeCategoryChart';
                if(Object.keys(m).length===0){ document.getElementById(cid).innerHTML='<div class="empty-state-small">æš‚æ— æ•°æ®</div>'; return; }
                let h='';
                Object.entries(m).sort((a,b)=>b[1]-a[1]).forEach(([cat,amt])=>{ const p=total>0?amt/total*100:0; h+=`<div class="category-item"><span class="category-name">${cat}</span><div class="category-bar-container"><div class="category-bar-bg"><div class="category-bar-fill" style="width:${p}%"></div></div></div><div class="category-amount">Â¥${amt.toFixed(2)}<span class="category-percent">${p.toFixed(1)}%</span></div></div>`; });
                document.getElementById(cid).innerHTML=h;
            }
            function renderTrendChart(){
                let h='', has=false, maxD=0;
                for(let i=6;i>=0;i--){
                    const d=new Date(); d.setDate(d.getDate()-i); const ds=d.toISOString().slice(0,10);
                    let day=0; transactions.forEach(t=>{if(t.date===ds&&t.type==='expense'){day+=t.amount; has=true;}});
                    if(day>maxD) maxD=day;
                }
                for(let i=6;i>=0;i--){
                    const d=new Date(); d.setDate(d.getDate()-i); const ds=d.toISOString().slice(0,10);
                    const w=['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'][d.getDay()];
                    let day=0; transactions.forEach(t=>{if(t.date===ds&&t.type==='expense') day+=t.amount;});
                    const p=maxD>0?day/maxD*100:0;
                    h+=`<div class="chart-bar-container"><div class="chart-bar-label"><span>${ds.slice(5)} ${w}</span><span>Â¥${day.toFixed(2)}</span></div><div class="chart-bar-bg"><div class="chart-bar-fill" style="width:${p}%"></div></div></div>`;
                }
                document.getElementById('trendChart').innerHTML=has?h:'<div class="empty-state-small">è¿‘7å¤©æ— æ”¯å‡ºè®°å½•</div>';
            }
            function renderRules() {
                let h='';
                rules.forEach((r,i)=>{ h+=`<div style="background:#f1f5f9; border-radius:40px; padding:10px 16px; margin:6px 0; display:flex; justify-content:space-between;"><span><span style="font-weight:600;">"${r.keyword}"</span> â†’ ${r.category}</span><button class="delete-rule" data-index="${i}" style="background:none; border:none; color:#c83e4d; cursor:pointer;">âœ•</button></div>`; });
                document.getElementById('rulesList').innerHTML=h||'<div class="empty-state-small">æš‚æ— è§„åˆ™</div>';
                document.querySelectorAll('.delete-rule').forEach(btn=>btn.addEventListener('click',function(){const i=this.dataset.index; rules.splice(i,1); saveUserData(); renderRules();}));
            }
            function updateAll() { updateCurrentIncomeExpense(); updateRangeStats(); renderFilteredList(); renderRules(); renderReports(); }

            // ========== äº‹ä»¶ç»‘å®š ==========
            document.querySelectorAll('.tab').forEach(tab=>tab.addEventListener('click',function(){
                document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); this.classList.add('active');
                const tn=this.dataset.tab; document.querySelectorAll('.tab-content').forEach(c=>{c.classList.remove('active'); if(c.id===tn+'Tab') c.classList.add('active'); });
                if(tn==='reports') renderReports();
            }));

            document.getElementById('timeRangeSelect')?.addEventListener('change',function(){
                const r=this.value; currentTimeRange=r;
                document.getElementById('customDateRange').style.display=r==='custom'?'flex':'none';
                if(r!=='custom'){ updateCurrentIncomeExpense(); updateRangeStats(); renderFilteredList(); }
                else { customStartDate=''; customEndDate=''; }
            });

            document.getElementById('queryCustomBtn')?.addEventListener('click', queryCustomRange);
            document.querySelectorAll('.filter-chip').forEach(chip=>chip.addEventListener('click',function(){
                document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active')); this.classList.add('active');
                currentFilter=this.dataset.filter; renderFilteredList();
            }));

            document.getElementById('avatarBtn')?.addEventListener('click',()=>document.getElementById('authOverlay').style.display='flex');
            document.getElementById('loginTab')?.addEventListener('click',function(){
                loginTab.classList.add('active'); registerTab.classList.remove('active');
                document.getElementById('loginForm').style.display='block'; document.getElementById('registerForm').style.display='none';
            });
            document.getElementById('registerTab')?.addEventListener('click',function(){
                registerTab.classList.add('active'); loginTab.classList.remove('active');
                document.getElementById('registerForm').style.display='block'; document.getElementById('loginForm').style.display='none';
            });
            document.getElementById('loginBtn')?.addEventListener('click',function(){
                const u=document.getElementById('loginUsername').value.trim(), p=document.getElementById('loginPassword').value;
                const users=JSON.parse(localStorage.getItem(USERS_KEY));
                if(!users[u]||users[u].password!==p){ alert('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'); return; }
                currentUser={username:u,data:users[u]}; localStorage.setItem(SESSION_KEY,JSON.stringify(currentUser));
                document.getElementById('authOverlay').style.display='none'; updateUIForUser(); loadUserData(); alert('ç™»å½•æˆåŠŸï¼');
            });
            document.getElementById('registerBtn')?.addEventListener('click',function(){
                const u=document.getElementById('registerUsername').value.trim(), p=document.getElementById('registerPassword').value, c=document.getElementById('registerConfirm').value;
                if(!u||!p){ alert('ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º'); return; }
                if(p!==c){ alert('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´'); return; }
                const users=JSON.parse(localStorage.getItem(USERS_KEY));
                if(users[u]){ alert('ç”¨æˆ·åå·²å­˜åœ¨'); return; }
                users[u]={password:p,createdAt:new Date().toISOString(),transactions:[]};
                localStorage.setItem(USERS_KEY,JSON.stringify(users));
                currentUser={username:u,data:users[u]}; localStorage.setItem(SESSION_KEY,JSON.stringify(currentUser));
                document.getElementById('authOverlay').style.display='none'; updateUIForUser(); loadUserData(); alert('æ³¨å†ŒæˆåŠŸï¼');
            });
            document.getElementById('logoutBtn')?.addEventListener('click',function(){
                currentUser=null; localStorage.removeItem(SESSION_KEY); updateUIForUser(); loadGuestData(); document.getElementById('authOverlay').style.display='none';
            });

            document.getElementById('wechatBtn')?.addEventListener('click',function(){
                wechatBtn.classList.add('active'); alipayBtn.classList.remove('active'); currentImportType='wechat';
            });
            document.getElementById('alipayBtn')?.addEventListener('click',function(){
                alipayBtn.classList.add('active'); wechatBtn.classList.remove('active'); currentImportType='alipay';
            });
            document.getElementById('parseBtn')?.addEventListener('click',()=>document.getElementById('fileInput').click());

            document.getElementById('fileInput')?.addEventListener('change',async function(e){
                const file=e.target.files[0]; if(!file) return;
                document.getElementById('importPreview').innerHTML='<div style="text-align:center;">â³ æ­£åœ¨è§£æ...</div>';
                try {
                    let records=[];
                    if(currentImportType==='wechat'){
                        if(!file.name.toLowerCase().includes('.xlsx')&&!file.name.toLowerCase().includes('.xls')){ alert('è¯·é€‰æ‹©å¾®ä¿¡è´¦å•çš„ .xlsx æˆ– .xls æ–‡ä»¶'); return; }
                        records=await parseWechatXLSX(file);
                    } else {
                        if(!file.name.toLowerCase().includes('.csv')){ alert('è¯·é€‰æ‹©æ”¯ä»˜å®è´¦å•çš„ .csv æ–‡ä»¶'); return; }
                        let text=await file.text();
                        records=parseAlipayCSV(text);
                        const hasMoji=records.some(r=>containsMoji(r.merchant));
                        if(hasMoji && records.length>0){
                            console.log('æ£€æµ‹åˆ°ä¹±ç ï¼Œå°è¯•GBK');
                            const reader=new FileReader();
                            const gbkText=await new Promise(resolve=>{ reader.onload=e=>resolve(e.target.result); reader.readAsText(file,'gbk'); });
                            records=parseAlipayCSV(gbkText);
                        }
                    }
                    const uniqueRecords=removeDuplicates(records);
                    displayImportPreview(uniqueRecords, records.length-uniqueRecords.length);
                } catch(error){ console.error(error); document.getElementById('importPreview').innerHTML=`<div style="color:#c00; text-align:center;">âŒ è§£æå¤±è´¥: ${error.message}</div>`; }
            });

            document.getElementById('addRuleBtn')?.addEventListener('click',function(){
                const kw=document.getElementById('newRuleKeyword').value.trim(); if(!kw) return alert('è¯·è¾“å…¥å…³é”®è¯');
                rules.push({keyword:kw,category:document.getElementById('newRuleCategory').value}); saveUserData(); renderRules(); document.getElementById('newRuleKeyword').value='';
            });

            const overlay=document.getElementById('drawerOverlay');
            document.getElementById('showAddDrawer')?.addEventListener('click',function(){
                if(!currentUser){ alert('è¯·å…ˆç™»å½•åå†è®°è´¦'); document.getElementById('authOverlay').style.display='flex'; return; }
                overlay.style.display='flex';
            });
            document.getElementById('cancelDrawer')?.addEventListener('click',()=>overlay.style.display='none');
            document.getElementById('saveTransaction')?.addEventListener('click',function(){
                const amt=parseFloat(document.getElementById('amountInput').value); if(isNaN(amt)||amt<=0) return alert('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢');
                const tx={ id:Date.now(), amount:amt, type:document.getElementById('expenseTypeBtn').classList.contains('active')?'expense':'income', category:document.getElementById('categorySelect').value, description:document.getElementById('descInput').value||'æ‰‹åŠ¨è®°è´¦', merchant:document.getElementById('descInput').value||'æ‰‹åŠ¨è®°è´¦', date:getToday() };
                transactions.push(tx); saveUserData(); updateAll(); overlay.style.display='none'; document.getElementById('amountInput').value=''; document.getElementById('descInput').value='';
            });

            document.getElementById('expenseTypeBtn')?.addEventListener('click',function(){ expenseTypeBtn.classList.add('active'); incomeTypeBtn.classList.remove('active'); });
            document.getElementById('incomeTypeBtn')?.addEventListener('click',function(){ incomeTypeBtn.classList.add('active'); expenseTypeBtn.classList.remove('active'); });

            document.querySelectorAll('.category-tab').forEach(tab=>tab.addEventListener('click',function(){
                const cat=this.dataset.category; currentCategoryTab=cat;
                document.querySelectorAll('.category-tab').forEach(el=>el.classList.remove('active')); this.classList.add('active');
                document.getElementById('expenseCategoryChart').style.display=cat==='expense'?'block':'none';
                document.getElementById('incomeCategoryChart').style.display=cat==='income'?'block':'none';
            }));

            document.getElementById('authOverlay')?.addEventListener('click',function(e){ if(e.target===this) this.style.display='none'; });
        }
    })();
</script>
</body>
</html>